generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Salon {
  id           Int            @id @default(autoincrement())
  name         String
  logoUrl      String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  appointments Appointment[]
  settings     SalonSettings?
  users        SalonUser[]
  services     Service[]
  staff        Staff[]
  customers    Customer[]
}

model SalonSettings {
  id            Int      @id @default(autoincrement())
  workStartHour Int      @default(9)
  workEndHour   Int      @default(18)
  slotInterval  Int      @default(30)
  timezone      String   @default("Europe/Istanbul")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  salonId       Int      @unique
  salon         Salon    @relation(fields: [salonId], references: [id])
}

model SalonUser {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  role         UserRole
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  salonId      Int
  salon        Salon    @relation(fields: [salonId], references: [id])
  staffProfile Staff?
}

model Staff {
  id           Int           @id @default(autoincrement())
  name         String
  phone        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  salonId      Int
  userId       Int?          @unique
  appointments Appointment[]
  leaves       Leave[]
  salon        Salon         @relation(fields: [salonId], references: [id])
  user         SalonUser?    @relation(fields: [userId], references: [id])
  services     Service[]     @relation("StaffServices")
}

model Leave {
  id        Int      @id @default(autoincrement())
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  reason    String?
  createdAt DateTime @default(now())
  staffId   Int
  staff     Staff    @relation(fields: [staffId], references: [id])
}

model Service {
  id           Int           @id @default(autoincrement())
  name         String
  description  String?
  price        Float
  duration     Int
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  salonId      Int
  appointments Appointment[]
  salon        Salon         @relation(fields: [salonId], references: [id])
  staff        Staff[]       @relation("StaffServices")
}

model Appointment {
  id            Int               @id @default(autoincrement())
  customerName  String
  customerPhone String
  customerId    Int?
  startTime     DateTime
  endTime       DateTime
  status        AppointmentStatus @default(BOOKED)
  source        AppointmentSource @default(CUSTOMER)
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  salonId       Int
  staffId       Int
  serviceId     Int
  salon         Salon             @relation(fields: [salonId], references: [id])
  service       Service           @relation(fields: [serviceId], references: [id])
  staff         Staff             @relation(fields: [staffId], references: [id])
  customer      Customer?         @relation(fields: [customerId], references: [id])

  @@index([staffId, startTime, endTime])
}

enum UserRole {
  OWNER
  STAFF
  MANAGER
  RECEPTION
  FINANCE
}

enum AppointmentStatus {
  BOOKED
  CANCELLED
  NO_SHOW
  COMPLETED
}

enum AppointmentSource {
  CUSTOMER
  ADMIN
  AUTOMATION
}

model MagicLink {
  id        Int         @id @default(autoincrement())
  token     String      @unique
  phone     String
  type      MagicLinkType
  context   Json?
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

enum CustomerGender {
  male
  female
  other
}

model Customer {
  id              Int             @id @default(autoincrement())
  name            String?
  phone           String
  gender          CustomerGender?
  birthDate       DateTime?       @db.Date
  acceptMarketing Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  salonId         Int
  salon           Salon           @relation(fields: [salonId], references: [id])
  appointments    Appointment[]

  @@unique([phone, salonId])
}

enum MagicLinkType {
  BOOKING
  RESCHEDULE
}

model CustomerBehaviorLog {
  id             Int      @id @default(autoincrement())
  customerId     Int
  salonId        Int
  appointmentId  Int?
  action         String
  behaviorType   String?
  severityScore  Float?
  metadata       Json?
  occurredAt     DateTime @default(now())
  createdAt      DateTime @default(now())
}

model CustomerRiskProfile {
  id                      Int     @id @default(autoincrement())
  customerId              Int
  salonId                 Int
  riskScore               Float   @default(0)
  riskLevel               String?
  noShowCount             Int     @default(0)
  noShows                 Int     @default(0)
  lastMinuteCount         Int     @default(0)
  lastMinuteCancellations Int     @default(0)
  totalBookings           Int     @default(0)
  lastCalculatedAt        DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@unique([customerId, salonId])
}

model SalonRiskConfig {
  id                      Int     @id @default(autoincrement())
  salonId                 Int     @unique
  isEnabled               Boolean @default(false)
  lastMinuteHoursThreshold Int    @default(24)
  noShowPenalty           Float   @default(0.1)
  lastMinutePenalty       Float   @default(0.05)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}
