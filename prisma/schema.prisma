generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Salon {
  id              Int               @id @default(autoincrement())
  name            String
  logoUrl         String?
  chakraPluginId  String?
  createdAt       DateTime?         @default(now()) @db.Timestamp(6)
  updatedAt       DateTime?         @default(now()) @updatedAt @db.Timestamp(6)
  slug            String?           @unique(map: "salon_slug_unique")
  appointments    Appointment[]
  customers       Customer[]
  settings        SalonSettings?
  users           SalonUser[]
  services        Service[]
  ServiceCategory ServiceCategory[]
  staff           Staff[]
}

model SalonSettings {
  id            Int       @id @default(autoincrement())
  workStartHour Int       @default(9)
  workEndHour   Int       @default(18)
  slotInterval  Int       @default(30)
  timezone      String    @default("Europe/Istanbul")
  categoryOrder Json?     // List of category keys for custom ordering
  createdAt     DateTime? @default(now()) @db.Timestamp(6)
  updatedAt     DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  salonId       Int       @unique
  salon         Salon     @relation(fields: [salonId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model SalonUser {
  id           Int       @id @default(autoincrement())
  email        String
  passwordHash String
  role         String
  createdAt    DateTime? @default(now()) @db.Timestamp(6)
  updatedAt    DateTime? @default(now()) @updatedAt @db.Timestamp(6)
  salonId      Int
  salon        Salon     @relation(fields: [salonId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Staff {
  id                Int                 @id @default(autoincrement())
  name              String
  phone             String?
  createdAt         DateTime?           @default(now()) @db.Timestamp(6)
  updatedAt         DateTime?           @default(now()) @updatedAt @db.Timestamp(6)
  salonId           Int
  userId            Int?
  appointments      Appointment[]
  leaves            Leave[]
  salon             Salon               @relation(fields: [salonId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  StaffService      StaffService[]
  StaffWorkingHours StaffWorkingHours[]
}

model Leave {
  id        Int       @id @default(autoincrement())
  startDate DateTime  @db.Date
  endDate   DateTime  @db.Date
  reason    String?
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  staffId   Int
  staff     Staff     @relation(fields: [staffId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model Service {
  id                 Int              @id @default(autoincrement())
  name               String
  description        String?
  price              Float
  duration           Int
  createdAt          DateTime?        @default(now()) @db.Timestamp(6)
  updatedAt          DateTime?        @default(now()) @updatedAt @db.Timestamp(6)
  salonId            Int
  category           String?
  requiresSpecialist Boolean?         @default(false)
  categoryId         Int?
  capacityOverride   Int?
  sequentialOverride Boolean?
  bufferOverride     Int?
  appointments       Appointment[]
  ServiceCategory    ServiceCategory? @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  salon              Salon            @relation(fields: [salonId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ServiceGender      ServiceGender[]
  ServiceStats       ServiceStats[]
  StaffService       StaffService[]

  @@unique([name, salonId])
}

model Appointment {
  id            Int                @id @default(autoincrement())
  customerName  String
  customerPhone String
  customerId    Int?
  startTime     DateTime           @db.Timestamp(6)
  endTime       DateTime           @db.Timestamp(6)
  status        AppointmentStatus? @default(BOOKED)
  source        AppointmentSource? @default(CUSTOMER)
  notes         String?
  createdAt     DateTime?          @default(now()) @db.Timestamp(6)
  updatedAt     DateTime?          @default(now()) @updatedAt @db.Timestamp(6)
  salonId       Int
  staffId       Int
  serviceId     Int
  gender        CustomerGender     @default(female)
  customer      Customer?          @relation(fields: [customerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  salon         Salon              @relation(fields: [salonId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  service       Service            @relation(fields: [serviceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  staff         Staff              @relation(fields: [staffId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([staffId, startTime, endTime], map: "idx_staff_time")
}

model SearchContext {
  id        String   @id @default(uuid())
  salonId   Int
  data      Json
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model MagicLink {
  id        Int           @id @default(autoincrement())
  token     String        @unique
  phone     String
  type      MagicLinkType
  context   Json?
  expiresAt DateTime      @db.Timestamp(6)
  usedAt    DateTime?     @db.Timestamp(6)
  createdAt DateTime?     @default(now()) @db.Timestamp(6)
  updatedAt DateTime?     @default(now()) @updatedAt @db.Timestamp(6)
}

model Customer {
  id              Int             @id @default(autoincrement())
  name            String?
  phone           String
  createdAt       DateTime?       @default(now()) @db.Timestamp(6)
  updatedAt       DateTime?       @default(now()) @updatedAt @db.Timestamp(6)
  salonId         Int
  gender          CustomerGender?
  birthDate       DateTime?       @db.Date
  acceptMarketing Boolean?        @default(false)
  appointments    Appointment[]
  salon           Salon           @relation(fields: [salonId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([phone, salonId])
}

model CustomerBehaviorLog {
  id            Int       @id @default(autoincrement())
  customerId    Int
  salonId       Int
  appointmentId Int?
  action        String
  behaviorType  String?
  severityScore Float?
  metadata      Json?
  occurredAt    DateTime? @default(now()) @db.Timestamp(6)
  createdAt     DateTime? @default(now()) @db.Timestamp(6)
}

model CustomerRiskProfile {
  id                      Int       @id @default(autoincrement())
  customerId              Int
  salonId                 Int
  riskScore               Float?    @default(0)
  riskLevel               String?
  noShowCount             Int?      @default(0)
  noShows                 Int?      @default(0)
  lastMinuteCount         Int?      @default(0)
  lastMinuteCancellations Int?      @default(0)
  totalBookings           Int?      @default(0)
  lastCalculatedAt        DateTime? @db.Timestamp(6)
  createdAt               DateTime? @default(now()) @db.Timestamp(6)
  updatedAt               DateTime? @default(now()) @updatedAt @db.Timestamp(6)

  @@unique([customerId, salonId])
}

model SalonRiskConfig {
  id                       Int       @id @default(autoincrement())
  salonId                  Int       @unique
  isEnabled                Boolean?  @default(false)
  lastMinuteHoursThreshold Int?      @default(24)
  noShowPenalty            Float?    @default(0.1)
  lastMinutePenalty        Float?    @default(0.05)
  createdAt                DateTime? @default(now()) @db.Timestamp(6)
  updatedAt                DateTime? @default(now()) @updatedAt @db.Timestamp(6)
}

model ServiceStats {
  serviceId    Int
  minPrice     Float
  maxPrice     Float
  minDuration  Int
  maxDuration  Int
  calculatedAt DateTime?      @default(now()) @db.Timestamp(6)
  salonId      Int
  gender       CustomerGender @default(female)
  Service      Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([serviceId, salonId, gender])
}

model StaffService {
  id                     Int                      @id @default(autoincrement())
  staffId                Int
  serviceId              Int
  price                  Float
  duration               Int
  isactive               Boolean?                 @default(true)
  gender                 CustomerGender           @default(female)
  Service                Service                  @relation(fields: [serviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  Staff                  Staff                    @relation(fields: [staffId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  StaffServiceCustomSlot StaffServiceCustomSlot[]

  @@unique([staffId, serviceId, gender], map: "StaffService_staff_service_gender_key")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model StaffWorkingHours {
  id        Int       @id @default(autoincrement())
  staffId   Int
  dayOfWeek Int?
  startHour Int
  endHour   Int
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  updatedAt DateTime? @default(now()) @db.Timestamp(6)
  Staff     Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model ServiceCategory {
  id                 Int       @id @default(autoincrement())
  name               String
  salonId            Int
  capacity           Int?      @default(1)
  sequentialRequired Boolean?  @default(false)
  bufferMinutes      Int?      @default(0)
  createdAt          DateTime? @default(now()) @db.Timestamp(6)
  updatedAt          DateTime? @default(now()) @db.Timestamp(6)
  Service            Service[]
  Salon              Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model ServiceGender {
  serviceId Int
  gender    CustomerGender
  Service   Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([serviceId, gender])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model StaffServiceCustomSlot {
  id             Int          @id @default(autoincrement())
  staffServiceId Int
  dayOfWeek      Int
  startTime      DateTime     @db.Time(6)
  createdAt      DateTime?    @default(now()) @db.Timestamp(6)
  StaffService   StaffService @relation(fields: [staffServiceId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_staffservice")
}

enum UserRole {
  OWNER
  STAFF
  MANAGER
  RECEPTION
  FINANCE
}

enum AppointmentStatus {
  BOOKED
  CANCELLED
  NO_SHOW
  COMPLETED
}

enum AppointmentSource {
  CUSTOMER
  ADMIN
  AUTOMATION
}

enum CustomerGender {
  male
  female
  other
}

enum MagicLinkType {
  BOOKING
  RESCHEDULE
}
